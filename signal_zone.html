<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umoja - 5G Coverage Check</title>

  <!-- Leaflet CSS for map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/x-icon" href="https://portal.umoja.network/custom_icons/1b42d87b8a41687683505729c1d20873/apple-icon-57x57.png" />

  <style>
    body { margin:0; font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f9;}
    #map { height:100vh; width:100%; }
    .coverage-checker {
      position:absolute;top:20px;left:20px;z-index:1000;background:white;padding:25px;border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.1);width:380px;max-width:90%;border-top:5px solid #EC008C;
    }
    .coverage-checker h2 {margin-top:0;font-size:22px;color:#333;}
    .input-group {margin-top:20px;}
    .input-group label {display:block;font-weight:600;margin-bottom:8px;color:#555;}
    .input-group input {width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:16px;box-sizing:border-box;}
    .input-group input:focus {border-color:#EC008C;outline:none;}
    .button-group {margin-top:20px;display:flex;flex-direction:column;gap:10px;}
    .btn {padding:12px 15px;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;
      transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:8px;}
    .btn-primary {background:#EC008C;color:white;}
    .btn-primary:hover {background:#c40073;transform:translateY(-2px);}
    .btn-secondary {background:#e9ecef;color:#333;}
    .btn-secondary:hover {background:#d8dde2;}
    #step-2-result {display:none;}
    .result-message {text-align:center;}
    .result-icon {font-size:48px;}
    .success-message .result-icon {color:#28a745;}
    .failure-message .result-icon {color:#dc3545;}
    .result-message h3 {font-size:20px;margin:15px 0 10px;}
    .result-message p {color:#666;margin-bottom:20px;}
    .legend {position:absolute;bottom:20px;right:20px;background:rgba(255,255,255,0.9);padding:12px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:1000;}
    .legend h4 {margin:0 0 10px;font-size:14px;}
    .legend div {display:flex;align-items:center;font-size:13px;margin-bottom:5px;}
    .legend span {width:16px;height:16px;margin-right:8px;border-radius:4px;}
    .spinner {border:4px solid rgba(0,0,0,0.1);border-left-color:#EC008C;border-radius:50%;width:20px;height:20px;
      animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

  <div class="coverage-checker">
    <div id="step-1-input">
      <img src="assets/logo.avif" alt="Umoja Logo" width="120" style="margin-bottom: 15px;">
      <h2>Check Your 5G Coverage</h2>
      <div class="input-group">
        <label for="address">Enter your full address to begin</label>
        <input type="text" id="address" placeholder="e.g., 123 Main Street, Soweto">
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="searchAddress()" id="searchBtn"><i class="bi bi-search"></i> Check Address</button>
        <button class="btn btn-secondary" onclick="getLocation()"><i class="bi bi-geo-alt-fill"></i> Use My Current Location</button>
      </div>
    </div>

    <div id="step-2-result">
      <div class="result-message success-message" id="result-success" style="display: none;">
        <div class="result-icon">âœ…</div>
        <h3>Great News! You're Covered.</h3>
        <p>Your location is within our high-speed 5G coverage zone.</p>
       <button class="btn btn-primary" onclick="window.location.href='application.html?address='+encodeURIComponent(addr)">
  <i class="bi bi-file-earmark-text-fill"></i> Apply Now & Get Connected
</button>

      </div>
      <div class="result-message failure-message" id="result-failure" style="display: none;">
        <div class="result-icon">ðŸ“¡</div>
        <h3>You're Just Outside Our Zone</h3>
        
       ]
        <button class="btn btn-primary" style="margin-top:10px; display:none"><i class="bi bi-envelope-fill"></i> Notify Me</button>
      </div>
      <button class="btn btn-secondary" style="margin-top: 15px;" onclick="resetChecker()">Check Another Address</button>
    </div>
  </div>

  <div id="map"></div>

  <div class="legend">
    <h4>Signal Strength</h4>
    <!-- Legend color updated to light blue -->
    <div><span style="background-color: #29b6f6;"></span> Strong</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0"></script>
  <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>

  <script>
    
    let GOOGLE_API_KEY = '';

async function loadApiKey() {
  try {
    const res = await fetch('API_KEY.json');
    const data = await res.json();
    GOOGLE_API_KEY = data.GOOGLE_API_KEY;
  } catch (e) {
    console.error('Failed to load API key:', e);
  }
}

// Call this at the start
loadApiKey();

    let addr = ''; 
    const lenasiaCoords = [-26.3167, 27.8333];
    const maxDistanceMeters = 30000;
    const map = L.map('map').setView(lenasiaCoords, 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    const boundaryCircle = L.circle(lenasiaCoords, { 
        radius: maxDistanceMeters, 
        weight: 0, 
        opacity: 0, 
        fillOpacity: 0, 
        interactive: false 
    }).addTo(map);

    map.fitBounds(boundaryCircle.getBounds());
    
    let coverageZones = []; 
    let userMarker = null;

    // Helper function to convert hex color to rgba
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    fetch("assets/towers.kmz")
      .then(r => r.arrayBuffer()).then(JSZip.loadAsync).then(z => z.file(Object.keys(z.files).find(n=>n.endsWith('.kml'))).async("string"))
      .then(kmlText => {
        const geojson = toGeoJSON.kml(new DOMParser().parseFromString(kmlText, "text/xml"));
        const lenasiaLatLng = L.latLng(lenasiaCoords);
        const heatPoints = [];

        geojson.features.forEach(f => {
          if (f.geometry.type === "Point") {
            const [lng, lat] = f.geometry.coordinates;
            if (lenasiaLatLng.distanceTo(L.latLng(lat, lng)) <= maxDistanceMeters) {
              
              const excellentRadius = 2000;
              const goodRadius = 5000; // This is the radius from the KMZ, but we'll use 3KM for the check
              coverageZones.push({
                  latlng: L.latLng(lat, lng),
                  excellentRadius: excellentRadius,
                  goodRadius: goodRadius // Keeping for other potential uses, but not directly used in checkCoverage for the distance itself
              });

              heatPoints.push([lat, lng, 1.0]); 

              for (let i = 0; i < 10; i++) {
                  const angle = Math.random() * 2 * Math.PI;
                  const distance = Math.random() * (goodRadius - excellentRadius) + excellentRadius;
                  const pointLat = lat + (distance / 111111) * Math.cos(angle);
                  const pointLng = lng + (distance / (111111 * Math.cos(lat * Math.PI / 180))) * Math.sin(angle);
                  heatPoints.push([pointLat, pointLng, 0.5]);
              }
            }
          }
        });

        // âœ… fixed heatmap gradient stops
        L.heatLayer(heatPoints, {
          minOpacity: 0.5,
          maxZoom: 18,
          radius: 20,
          blur: 15,
          gradient: {
            0.2: '#e1f5fe', // very pale blue
            0.4: '#81d4fa', // soft light blue
            0.7: '#29b6f6'  // bright sky blue
          }
        }).addTo(map);
      });

    const greenIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    function showLoading(isLoading) {
      const searchBtn = document.getElementById('searchBtn');
      if (isLoading) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = `<div class="spinner"></div> Checking...`;
      } else {
        searchBtn.disabled = false;
        searchBtn.innerHTML = `<i class="bi bi-search"></i> Check Address`;
      }
    }

    function showResult(isCovered) {
      document.getElementById('step-1-input').style.display = 'none';
      document.getElementById('step-2-result').style.display = 'block';
      document.getElementById('result-success').style.display = isCovered ? 'block' : 'none';
      document.getElementById('result-failure').style.display = isCovered ? 'none' : 'block';
    }

    function resetChecker() {
      if (userMarker) map.removeLayer(userMarker);
      document.getElementById('address').value = '';
      document.getElementById('step-2-result').style.display = 'none';
      document.getElementById('step-1-input').style.display = 'block';
      map.flyTo(lenasiaCoords, 10);
    }

    function cleanAddress(query) {
      return query.replace(/^Cnr\s+/i, "")
                  .replace(/\s*,\s*/g, " ")
                  .replace(/&/g, "and")
                  .trim();
    }

    async function searchAddress() {
      let query = document.getElementById("address").value;
      if (!query) { alert("Please enter an address."); return; }
      query = cleanAddress(query);
    
      showLoading(true);

      try {
        let url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=za&q=${encodeURIComponent(query)}`;
        let res = await fetch(url);
        let data = await res.json();

        if (data.length > 0) {
          showLoading(false);
          checkCoverage([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
          return;
        }

        let gUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&region=za&key=${GOOGLE_API_KEY}`;
        let gRes = await fetch(gUrl);
        let gData = await gRes.json();

        if (gData.status === "OK" && gData.results.length > 0) {
          const loc = gData.results[0].geometry.location;
          checkCoverage([loc.lat, loc.lng]);
        } else {
          alert("Address not found. Please try another format.");
        }
      } catch (e) {
        alert("Could not perform search.");
      } finally {
        showLoading(false);
      }
      
      const redirectUrl = '?'+'address='+query;
      addr = redirectUrl;
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          checkCoverage([pos.coords.latitude, pos.coords.longitude]);
        }, () => alert("Unable to retrieve your location."));
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    }

    function checkCoverage(latLngArray) {
      const latLng = L.latLng(latLngArray);
      if (userMarker) map.removeLayer(userMarker);

      // Check if the user's location is within 2000 meters (2KM) of any tower
      let isInCoverage = coverageZones.some(zone =>
        map.distance(latLng, zone.latlng) <= 2000 // Fixed 3000 meters (3KM
      );

      map.flyTo(latLng, 14);

      if (isInCoverage) {
        userMarker = L.marker(latLng, { icon: greenIcon })
          .addTo(map).bindPopup("<b>Great News!</b><br>You are in the coverage zone.").openPopup();
        showResult(true);
      } else {
        userMarker = L.marker(latLng)
          .addTo(map).bindPopup("<b>You're Not in the Coverage Zone</b><br>We're not here yet, but we hope to be soon!").openPopup(); // Updated message
        showResult(false);
      }
    }
  </script>
</body>
</html>